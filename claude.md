# 项目开发指导文档

## 项目定位

基于All-In-One音乐结构分析模型的企业级RESTful API服务，支持同步、异步、批量三种分析模式。

## 核心架构原则

### 1. 服务分离
- **API层**: FastAPI应用，处理HTTP请求
- **服务层**: 业务逻辑封装，核心算法调用
- **工具层**: 通用功能，文件处理、验证

### 2. 接口设计
- **标准化**: RESTful API + OpenAPI文档
- **类型安全**: Pydantic数据验证和序列化
- **异步优先**: 支持高并发和进度跟踪

### 3. 三种使用模式
- **同步分析**: 一次性调用，直接返回结果
- **异步分析**: 提交任务→进度跟踪→获取结果
- **批量分析**: 多文件并行处理，任务管理

## 技术栈决策

### 核心框架
- **FastAPI**: 自动API文档、类型检查、异步支持
- **Pydantic V2**: 数据验证、序列化、错误处理
- **Uvicorn**: ASGI服务器、生产就绪

### 容器化
- **Docker**: 多阶段构建，镜像优化
- **Docker Compose**: 本地开发、生产部署

## 项目结构规范

```
all-in-one-docker-cpu-apple-silicon/
├── 🚀 start-api.sh          # 一键启动脚本
├── 📁 api/                  # API服务代码
│   ├── main.py              # FastAPI应用入口
│   ├── models/              # 数据模型定义
│   ├── endpoints/           # API端点实现
│   ├── services/            # 业务逻辑服务
│   └── utils/               # 工具函数
├── 📁 scripts/              # 构建脚本
├── 📁 src/                  # allin1核心库
└── 🐳 docker-compose.yml    # 部署配置
```

## 设计原则

### 1. 向后兼容
- 保持原有CLI功能完全兼容
- Python库`pip install allin1`继续可用
- 提供平滑的迁移路径

### 2. 可扩展性
- 模块化设计，易于添加新功能
- 抽象服务层，支持不同后端实现
- 插件化架构，支持功能扩展

### 3. 企业级特性
- 内存文件处理，避免磁盘膨胀
- 完整错误处理和任务管理
- 系统监控和健康检查
- 并发控制和资源管理

## 扩展方向

### 1. 功能扩展
- **新分析模型**: 集成更多音乐分析模型
- **高级特性**: 实时处理、流式分析
- **输出格式**: 支持更多文件格式和数据结构

### 2. 架构扩展
- **认证授权**: JWT、API Key、OAuth2
- **任务队列**: Redis、Celery、RabbitMQ
- **存储后端**: 云存储、数据库
- **微服务**: 服务拆分、API网关

### 3. 部署扩展
- **容器编排**: Kubernetes、Swarm
- **云平台**: AWS、GCP、Azure
- **监控告警**: Prometheus、Grafana
- **日志聚合**: ELK Stack、Fluentd

## 性能优化

### 1. 模型管理
- **预加载**: 启动时加载模型
- **缓存策略**: 模型复用和热切换
- **动态加载**: 支持模型热更新

### 2. 文件处理
- **内存优化**: 流式处理大文件
- **并发控制**: 智能资源分配
- **缓存去重**: 文件哈希验证

### 3. 任务优化
- **并行处理**: 多文件同时分析
- **批量调度**: 智能任务排序
- **资源池**: 连接池和线程池管理

## 安全考虑

### 1. 输入验证
- **文件安全**: 格式、大小、内容验证
- **路径安全**: 防止目录遍历和路径注入
- **资源限制**: 文件大小、音频时长、并发数

### 2. 运行安全
- **最小权限**: 非root用户运行
- **网络隔离**: 容器网络和端口限制
- **数据保护**: 临时数据清理

### 3. API安全
- **输入验证**: Pydantic强制验证
- **错误处理**: 不泄露内部信息
- **访问控制**: 预留认证授权接口

## 监控指标

### 1. 业务指标
- **分析成功率**: 成功/总请求数
- **处理时间**: P50、P95、P99延迟
- **错误率**: 按类型分类的错误

### 2. 系统指标
- **资源使用**: 内存、磁盘、网络
- **容器状态**: 运行状态、重启次数
- **任务状态**: 活跃任务、排队任务

### 3. 功能指标
- **模型状态**: 加载状态、模型版本
- **文件处理**: 上传数量、存储使用
- **API调用**: 端点访问频率、响应时间

## 开发指南

### 1. 添加新功能
1. 在`models/`中定义数据模型
2. 在`services/`中实现业务逻辑
3. 在`endpoints/`中添加API端点
4. 更新API文档和测试

### 2. 代码规范
- 使用类型提示
- 遵循PEP 8规范
- 添加完整文档字符串
- 编写单元测试

### 3. 测试策略
- 单元测试：函数、类、模块测试
- 集成测试：API端点、服务层测试
- 性能测试：负载、压力、并发测试

## 部署策略

### 1. 开发环境
```bash
./start-api.sh  # 自动启动
```

### 2. 测试环境
```bash
docker-compose up --build  # 重建部署
```

### 3. 生产环境
```bash
# 多实例部署
docker-compose --profile production up -d

# 健康检查
curl http://localhost:8193/api/system/health
```

## 问题排查

### 1. 常见问题
- **模型加载失败**: 检查模型文件和权限
- **内存不足**: 调整容器资源限制
- **文件上传失败**: 检查文件格式和大小限制
- **API调用超时**: 调整超时设置和并发限制

### 2. 调试方法
- **日志分析**: 查看容器和API日志
- **健康检查**: 使用健康检查端点
- **性能分析**: 监控系统和API指标
- **资源监控**: 检查内存、磁盘使用

## 版本管理

### 1. 版本策略
- **主版本**: 重大架构变更（如v2.0.0）
- **次版本**: 新功能添加（如v2.1.0）
- **修订版本**: Bug修复和优化（如v2.0.1）

### 2. 发布流程
1. 功能开发和测试
2. 文档更新和审核
3. 版本号更新
4. 镜像构建和推送
5. 部署和验证
6. 发布公告

这个文档提供了项目开发的整体方向和原则性指导，帮助AI助手理解项目架构和开发重点。