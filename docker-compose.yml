# 音乐分析API Docker Compose配置
# 快速启动方式: docker-compose up --build

version: '3.8'

services:
  music-analysis-api:
    build:
      context: .
      dockerfile: api/Dockerfile
    container_name: music-analysis-api
    ports:
      - "8193:8000"
    volumes:
      # 持久化存储上传文件和结果
      - ./api/storage/uploads:/app/api/static/uploads
      - ./api/storage/results:/app/api/static/results
      - ./api/storage/temp:/app/api/temp
      # 开发时的代码热重载（可选）
      - ./api:/app/api
    environment:
      - ENV=development
      - LOG_LEVEL=info
      - PORT=8193
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/system/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    # 如果有GPU支持，取消注释以下行
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: 1
    #           capabilities: [gpu]

  # Redis服务（可选，用于任务队列和缓存）
  redis:
    image: redis:7-alpine
    container_name: music-analysis-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    restart: unless-stopped
    command: redis-server --appendonly yes
    profiles: ["with-redis"]

  # Nginx反向代理（可选，生产环境推荐）
  nginx:
    image: nginx:alpine
    container_name: music-analysis-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - music-analysis-api
    restart: unless-stopped
    profiles: ["production"]

volumes:
  redis_data:
    driver: local

networks:
  default:
    name: music-analysis-network